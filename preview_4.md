# Preview 4: Dependencies, Riverpod Architecture, and Auth Flow Deep Dive

## Table of Contents
1. [Project Dependencies](#project-dependencies)
2. [Riverpod Architecture Overview](#riverpod-architecture-overview)
3. [Auth Remote Repositories](#auth-remote-repositories)
4. [Auth ViewModel (Notifier)](#auth-viewmodel-notifier)
5. [The .g.dart Files Explained](#the-gdart-files-explained)
6. [How Riverpod Auto-Regeneration Works](#how-riverpod-auto-regeneration-works)
7. [Complete Data Flow](#complete-data-flow)
8. [Key Concepts](#key-concepts)

---

## Project Dependencies

### Core Dependencies (pubspec.yaml)

```yaml
dependencies:
  flutter:
    sdk: flutter

  # HTTP Client for API calls
  http: ^1.6.0
  # Functional programming utilities (Either, Option, etc.)
  fpdart: ^1.2.0
  # State management framework
  flutter_riverpod: ^2.5.1
  # Annotations for Riverpod code generation
  riverpod_annotation: ^2.3.5
```

### Dev Dependencies (for code generation)

```yaml
dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^5.0.0
  # Code generator for Riverpod
  riverpod_generator: ^2.4.0
  # Lints for Riverpod code
  riverpod_lint: ^2.3.10
  # Custom lint rules
  custom_lint: ^0.6.4
  # Build runner for generating code
  build_runner: ^2.4.10
```

### Dependency Explanation

| Dependency | Purpose |
|------------|---------|
| `http` | Makes HTTP requests to the backend server |
| `fpdart` | Provides functional programming types like `Either` for error handling |
| `flutter_riverpod` | State management - handles app-wide state |
| `riverpod_annotation` | Annotations used with Riverpod generators |
| `riverpod_generator` | Automatically generates provider code |
| `build_runner` | Executes code generators |
| `riverpod_lint` | Catches common Riverpod mistakes |

---

## Riverpod Architecture Overview

### What is Riverpod?

Riverpod is a state management library for Flutter that:
- Replaces the traditional `Provider` pattern
- Provides compile-time safety
- Enables dependency injection
- Supports async operations elegantly

### Riverpod Providers (The Core Concept)

```
┌─────────────────────────────────────────────────────────────┐
│                    Riverpod Ecosystem                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐│
│   │   Provider   │    │  Notifier    │    │   Future/    ││
│   │  (Simple)    │    │  (Stateful)  │    │   Stream     ││
│   └──────────────┘    └──────────────┘    └──────────────┘│
│         │                  │                  │             │
│         └──────────────────┼──────────────────┘             │
│                            ▼                                │
│              ┌─────────────────────────┐                   │
│              │   AutoDisposeProvider   │                   │
│              │   (Generated by @riverpod)                   │
│              └─────────────────────────┘                   │
│                            │                                │
│                            ▼                                │
│              ┌─────────────────────────┐                   │
│              │      ProviderContainer   │                   │
│              │   (Holds all providers)  │                   │
│              └─────────────────────────┘                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Types of Providers in This Project

1. **`AuthRemoteRepositories`** - A simple provider that returns an instance of the repository
2. **`AuthViewModel`** - A notifier provider that manages async state (loading, success, error)

---

## Auth Remote Repositories

### File: [`auth_remote_repositories.dart`](lib/features/auth/repositories/auth_remote_repositories.dart)

```dart
part 'auth_remote_repositories.g.dart';  // Include generated code

@riverpod
AuthRemoteRepositories authRemoteRepositories(AuthRemoteRepositoriesRef ref) {
  return AuthRemoteRepositories();
}

class AuthRemoteRepositories {
  // HTTP Methods for API calls
}
```

### What is a Repository?

A repository is an **abstraction layer** between the data source (API) and the rest of the app:

```
┌─────────────────────────────────────────────────────────┐
│                      UI Layer                           │
│              (SignInPage, SignUpPage)                   │
└─────────────────────┬───────────────────────────────────┘
                      │ calls
                      ▼
┌─────────────────────────────────────────────────────────┐
│                   ViewModel Layer                       │
│                   (AuthViewModel)                       │
└─────────────────────┬───────────────────────────────────┘
                      │ calls
                      ▼
┌─────────────────────────────────────────────────────────┐
│                 Repository Layer                        │
│             (AuthRemoteRepositories)                    │
└─────────────────────┬───────────────────────────────────┘
                      │ calls
                      ▼
┌─────────────────────────────────────────────────────────┐
│                   API Layer                             │
│                    (HTTP)                               │
└─────────────────────────────────────────────────────────┘
                      │
                      ▼
            ┌─────────────────────┐
            │   Backend Server     │
            │  (FastAPI/Python)    │
            └─────────────────────┘
```

### Repository Methods

#### 1. `signup()` Method

```dart
Future<Either<AppFailure, UserModel>> signup({
  required String name,
  required String email,
  required String password,
}) async {
  try {
    // Step 1: Make HTTP POST request
    final response = await http.post(
      Uri.parse('${ServerConstant.serverURL}/auth/signup'),
      headers: {'Content-Type': 'application/json'},
      body: jsonEncode({'name': name, 'email': email, 'password': password}),
    );

    // Step 2: Parse response
    final resBodyMap = json.decode(response.body) as Map<String, dynamic>;

    // Step 3: Check status code
    if (response.statusCode != 201) {
      return Left(AppFailure(resBodyMap['detail']));
    }

    // Step 4: Return success
    return Right(UserModel.fromMap(resBodyMap));
  } catch (e) {
    return Left(AppFailure(e.toString()));
  }
}
```

#### 2. `login()` Method

```dart
Future<Either<AppFailure, UserModel>> login({
  required String email,
  required String password,
}) async {
  // Similar structure to signup()
}
```

### The `Either` Type (from fpdart)

`Either` is a type that can hold one of two values:
- **`Left`** - Represents failure or error
- **`Right`** - Represents success

```
┌─────────────────────────────────────┐
│            Either<L, R>             │
└─────────────────┬───────────────────┘
                  │
        ┌─────────┴─────────┐
        │                   │
        ▼                   ▼
   ┌─────────┐        ┌─────────┐
   │  Left   │        │  Right  │
   │ (Error) │        │(Success)│
   └─────────┘        └─────────┘
   Left<AppFailure>   Right<UserModel>
```

---

## Auth ViewModel (Notifier)

### File: [`auth_viewmodel.dart`](lib/features/auth/viewmodel/auth_viewmodel.dart)

```dart
@riverpod
class AuthViewModel extends _$AuthViewModel {
  late AuthRemoteRepositories _authRemoteRepositories;

  @override
  AsyncValue<UserModel>? build() {
    _authRemoteRepositories = ref.watch(authRemoteRepositoriesProvider);
    return null;
  }

  Future<void> signUpuser({...}) async {
    state = const AsyncValue.loading();
    final res = await _authRemoteRepositories.signup(...);
    final val = switch (res) {
      Left(value: final l) => state = AsyncValue.error(...),
      Right(value: final r) => state = AsyncValue.data(r),
    };
  }
}
```

### What is a Notifier?

A Notifier is a Riverpod provider that:
- Extends `Notifier` or `AutoDisposeNotifier`
- Manages mutable state
- Exposes methods to update state
- Uses `@riverpod` annotation

### State Types

```
┌─────────────────────────────────────────────────────────────┐
│                    AsyncValue<T> States                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐│
│   │    Loading   │    │    Data      │    │    Error     ││
│   │              │    │   (Success)  │    │              ││
│   └──────────────┘    └──────────────┘    └──────────────┘│
│                                                             │
│   state =               state =               state =      │
│   AsyncValue.loading()  AsyncValue.data(r)   AsyncValue    │
│                                                  .error()   │
└─────────────────────────────────────────────────────────────┘
```

### ViewModel Methods

#### `signUpuser()` Flow

```
1. User fills form and taps "Sign Up"
         │
         ▼
2. UI calls: signUpuser(name, email, password)
         │
         ▼
3. Set state to LOADING
   state = AsyncValue.loading()
         │
         ▼
4. Call repository signup method
   _authRemoteRepositories.signup(...)
         │
         ▼
5. Repository makes HTTP request
         │
         ▼
6. Receive response (Left or Right)
         │
         ▼
7. Pattern match with switch expression
         │
         ├── Left → Set state to ERROR
         └── Right → Set state to DATA
         │
         ▼
8. UI rebuilds based on new state
```

---

## The .g.dart Files Explained

### What are .g.dart Files?

`.g.dart` stands for "**generated**". These files are:
- **Automatically created** by Riverpod code generator
- **Never edited manually** - regenerated on every build
- **Part of the Dart build system** (build_runner)

### File: [`auth_remote_repositories.g.dart`](lib/features/auth/repositories/auth_remote_repositories.g.dart)

```dart
// GENERATED CODE - DO NOT MODIFY BY HAND

part of 'auth_remote_repositories.dart';

// **************************************************************************
// RiverpodGenerator
// **************************************************************************

// Hash for change detection
String _$authRemoteRepositoriesHash() =>
    r'18c0df272073e6af4d7c4f13f656aeaa7b554030';

/// See also [authRemoteRepositories].
@ProviderFor(authRemoteRepositories)
final authRemoteRepositoriesProvider =
    AutoDisposeProvider<AuthRemoteRepositories>.internal(
  authRemoteRepositories,
  name: r'authRemoteRepositoriesProvider',
  debugGetCreateSourceHash: const bool.fromEnvironment('dart.vm.product')
      ? null
      : _$authRemoteRepositoriesHash,
  dependencies: null,
  allTransitiveDependencies: null,
);

typedef AuthRemoteRepositoriesRef
    = AutoDisposeProviderRef<AuthRemoteRepositories>;
```

### File: [`auth_viewmodel.g.dart`](lib/features/auth/viewmodel/auth_viewmodel.g.dart)

```dart
// GENERATED CODE - DO NOT MODIFY BY HAND

part of 'auth_viewmodel.dart';

// **************************************************************************
// RiverpodGenerator
// **************************************************************************

String _$authViewModelHash() => r'978b0d0e4fd444fb417ba42793b2bc54a6696a97';

/// See also [AuthViewModel].
@ProviderFor(AuthViewModel)
final authViewModelProvider =
    AutoDisposeNotifierProvider<AuthViewModel, AsyncValue<UserModel>?>.internal(
  AuthViewModel.new,
  name: r'authViewModelProvider',
  debugGetCreateSourceHash: const bool.fromEnvironment('dart.vm.product')
      ? null
      : _$authViewModelHash,
  dependencies: null,
  allTransitiveDependencies: null,
);

typedef _$AuthViewModel = AutoDisposeNotifier<AsyncValue<UserModel>?>;
```

### Breakdown of Generated Code

| Generated Element | Purpose |
|-------------------|---------|
| `String _$...Hash()` | Unique hash for change detection during rebuild |
| `@ProviderFor(...)` | Annotation marking this as a provider |
| `...Provider` | The actual provider object |
| `...Ref` | Reference type for the provider |
| `typedef _$...` | Type alias for the notifier |

### How the Generated Code Works

```
┌─────────────────────────────────────────────────────────────────┐
│              Generated Provider Structure                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   @riverpod                                                     │
│   class AuthRemoteRepositories {                                │
│     // Your code                                                 │
│   }                                                             │
│                        │                                        │
│                        ▼                                        │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │           riverpod_generator runs                        │   │
│   │           (via build_runner)                             │   │
│   └─────────────────────────────────────────────────────────┘   │
│                        │                                        │
│                        ▼                                        │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │           auth_remote_repositories.g.dart               │   │
│   │                                                         │   │
│   │   final authRemoteRepositoriesProvider =                │   │
│   │       AutoDisposeProvider<AuthRemoteRepositories>        │   │
│   │         .internal(                                       │   │
│   │           authRemoteRepositories,                         │   │
│   │           name: 'authRemoteRepositoriesProvider',        │   │
│   │           ...                                            │   │
│   │         );                                               │   │
│   │                                                         │   │
│   │   typedef AuthRemoteRepositoriesRef =                    │   │
│   │       AutoDisposeProviderRef<AuthRemoteRepositories>;    │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## How Riverpod Auto-Regeneration Works

### The Build Process

```
┌─────────────────────────────────────────────────────────────────┐
│                    Flutter Build Process                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. flutter run / flutter build                                │
│           │                                                     │
│           ▼                                                     │
│   2. Dart VM detects .g.dart files need regeneration           │
│           │                                                     │
│           ▼                                                     │
│   3. build_runner is invoked                                    │
│           │                                                     │
│           ▼                                                     │
│   4. riverpod_generator analyzes source files                   │
│           │                                                     │
│           ├── Finds @riverpod annotations                       │
│           ├── Parses class structure                            │
│           └── Generates providers                               │
│           │                                                     │
│           ▼                                                     │
│   5. .g.dart files are regenerated                              │
│           │                                                     │
│           ▼                                                     │
│   6. Compilation continues                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Commands for Regeneration

```bash
# Generate .g.dart files (one-time)
dart run build_runner build

# Watch for changes and regenerate (during development)
dart run build_runner watch

# Delete and regenerate all generated files
dart run build_runner clean
dart run build_runner build
```

### How Riverpod Detects Changes

```dart
String _$authRemoteRepositoriesHash() =>
    r'18c0df272073e6af4d7c4f13f656aeaa7b554030';

// When you modify the source file, the hash changes:
// String _$authRemoteRepositoriesHash() =>
//     r'NEW_DIFFERENT_HASH_HERE';

// Riverpod compares:
// 1. Current hash (from source)
// 2. Hash stored in .g.dart
// 3. If different → regenerate
```

### The `part` and `part of` System

```dart
// auth_remote_repositories.dart
part 'auth_remote_repositories.g.dart';  // Include generated code

// auth_remote_repositories.g.dart
part of 'auth_remote_repositories.dart';  // Belongs to source
```

```
┌─────────────────────────────────────────┐
│   auth_remote_repositories.dart         │
│   ┌─────────────────────────────────┐   │
│   │  Your Code (non-generated)     │   │
│   └─────────────────────────────────┘   │
│   ┌─────────────────────────────────┐   │
│   │  GENERATED CODE (included via   │   │
│   │  'part' directive)              │   │
│   └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

---

## Complete Data Flow

### Sign Up Flow

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                              Sign Up Flow                                     │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  User fills form                                                              │
│      │                                                                       │
│      ▼                                                                       │
┌─────────────────┐                                                             │
│  SignUpPage     │                                                             │
│  (UI Widget)    │                                                             │
└────────┬────────┘                                                             │
         │                                                                      │
         │ ref.read(authViewModelProvider).signUpuser(...)                      │
         │                                                                      │
         ▼                                                                       │
┌────────────────────────────────────────────────────────────────────────────┐ │
│                     AuthViewModel (Notifier)                                 │ │
│                                                                            │ │
│  @override                                                                  │ │
│  build() {                                                                  │ │
│    _authRemoteRepositories = ref.watch(authRemoteRepositoriesProvider);     │ │
│  }                                                                          │ │
│                                                                            │ │
│  signUpuser() {                                                             │ │
│    state = AsyncValue.loading();  // ← Set loading state                    │ │
│                                                                            │ │
│    final res = await _authRemoteRepositories.signup(...);                  │ │
│                                                                            │ │
│    switch (res) {                                                           │ │
│      Left(l) → state = AsyncValue.error(l.message);                         │ │
│      Right(r) → state = AsyncValue.data(r);                                │ │
│    }                                                                         │ │
│  }                                                                           │ │
└────────────────────────────────────────────────────────────────────────────┘ │
         │                                                                      │
         │ Uses repository to make API call                                     │
         ▼                                                                       │
┌────────────────────────────────────────────────────────────────────────────┐ │
│                     AuthRemoteRepositories                                   │ │
│                                                                            │ │
│  signup({name, email, password}) {                                           │ │
│    http.post(                                                               │ │
│      Uri.parse('http://127.0.0.1:8000/auth/signup'),                       │ │
│      body: jsonEncode({...}),                                               │ │
│    );                                                                        │ │
│  }                                                                           │ │
└────────────────────────────────────────────────────────────────────────────┘ │
         │                                                                      │
         │ Makes HTTP request                                                    │
         ▼                                                                       │
┌─────────────────┐                                                             │
│  HTTP Request   │  ─── POST /auth/signup ───►  Backend Server                │
└─────────────────┘                                                             │
                                                                              │
                         ◄── JSON Response ──                                  │
                                                                              │
         │                                                                      │
         │ Parse response, return Either                                        │
         ▼                                                                       │
┌────────────────────────────────────────────────────────────────────────────┐ │
│                     Either<AppFailure, UserModel>                           │ │
│                                                                            │ │
│  Left(AppFailure)  ──► Error state                                          │ │
│  Right(UserModel) ──► Success state                                         │ │
└────────────────────────────────────────────────────────────────────────────┘ │
         │                                                                      │
         │ State updated                                                         │
         ▼                                                                       │
┌─────────────────┐                                                             │
│  ConsumerWidget │  Listens to state changes                                  │
│  rebuilds UI    │  Shows loading/error/success UI                           │
└─────────────────┘                                                             │
                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## Key Concepts

### 1. Dependency Injection with `ref.watch()`

```dart
@override
AsyncValue<UserModel>? build() {
  // Get the repository instance
  _authRemoteRepositories = ref.watch(authRemoteRepositoriesProvider);
  return null;
}
```

- `ref.watch()` creates a dependency
- When `authRemoteRepositoriesProvider` changes, this rebuilds

### 2. Provider Types

| Type | Annotation | Generated Class | Use Case |
|------|------------|-----------------|----------|
| Simple Provider | `@riverpod` | `AutoDisposeProvider` | Return a single value/instance |
| Notifier | `@riverpod class X extends _$X` | `AutoDisposeNotifierProvider` | Manage mutable state |
| FutureProvider | `@riverpod Future<X> fn()` | `FutureProvider` | Async data |
| StreamProvider | `@riverpod Stream<X> fn()` | `StreamProvider` | Stream data |

### 3. Why AutoDispose?

```dart
// All providers in this project use AutoDispose
final authRemoteRepositoriesProvider =
    AutoDisposeProvider<AuthRemoteRepositories>.internal(...);
```

**Benefits:**
- Automatically cleans up when no longer used
- Prevents memory leaks
- Reduces resource usage

### 4. Error Handling with `Either`

```dart
// In repository
return Left(AppFailure(resBodyMap['detail']));  // Failure
return Right(UserModel.fromMap(resBodyMap));     // Success

// In ViewModel
switch (res) {
  Left(value: final l) => state = AsyncValue.error(l.message, ...),
  Right(value: final r) => state = AsyncValue.data(r),
}
```

---

## Summary

### File Structure

```
lib/
├── core/
│   ├── constants/
│   │   └── server_constant.dart      # Server URL
│   ├── failure/
│   │   └── failure.dart               # Error class
│   └── ...
├── features/
│   └── auth/
│       ├── model/
│       │   └── user_model.dart        # User data model
│       ├── repositories/
│       │   ├── auth_remote_repositories.dart      # Repository
│       │   └── auth_remote_repositories.g.dart    # GENERATED
│       ├── viewmodel/
│       │   ├── auth_viewmodel.dart               # Notifier
│       │   └── auth_viewmodel.g.dart             # GENERATED
│       └── view/                                  # UI
└── main.dart
```

### Key Takeaways

1. **Dependencies** are declared in `pubspec.yaml` and include Riverpod for state management
2. **Repositories** abstract API calls and return `Either<AppFailure, T>`
3. **ViewModels (Notifiers)** manage state using `AsyncValue<T>`
4. **`.g.dart` files** are auto-generated by `riverpod_generator`
5. **Regeneration** happens via `build_runner` when running `flutter run` or manually with `dart run build_runner build`
6. **`ref.watch()`** creates dependencies between providers
7. **AutoDispose** automatically cleans up unused providers

---

## Next Steps

To continue learning about this project:
- Explore the UI layer (SignInPage, SignUpPage)
- Learn how to consume providers in widgets
- Understand error handling patterns
- Add more features with the same pattern

---

*Generated on: 2026-02-03*
*Part of: Spotify Clone Project*
